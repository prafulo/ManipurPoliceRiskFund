// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

//
// ENUMS
//

enum MemberPostType {
  Officiating
  Temporary
  Substantive
}

enum MemberStatus {
  Opened
  Closed
}

enum ClosureReason {
  Retirement
  Death
  Doubling
  Expelled
}

//
// MODELS
//

model Unit {
  id    String   @id @db.VarChar(255)
  name  String   @unique @db.VarChar(255)

  membersFrom Member[] @relation("UnitMembers")
  transfersFrom Transfer[] @relation("FromUnit")
  transfersTo   Transfer[] @relation("ToUnit")

  @@map("units")
}

model Member {
  id                      String          @id @db.VarChar(255)
  membershipCode          String          @unique @map("membership_code") @db.VarChar(255)
  name                    String          @db.VarChar(255)
  fatherName              String          @map("father_name") @db.VarChar(255)
  rank                    String          @db.VarChar(255)
  trade                   String          @db.VarChar(255)
  serviceNumber           String          @map("service_number") @db.VarChar(255)
  badgeNumber             String          @map("badge_number") @db.VarChar(255)
  bloodGroup              String          @map("blood_group") @db.VarChar(50)
  memberPostType          MemberPostType  @map("member_post_type")
  joiningRank             String          @map("joining_rank") @db.VarChar(255)
  dateOfBirth             DateTime        @map("date_of_birth") @db.Date
  dateOfEnrollment        DateTime        @map("date_of_enrollment") @db.Date
  superannuationDate      DateTime        @map("superannuation_date") @db.Date
  dateOfDischarge         DateTime?       @map("date_of_discharge") @db.Date
  address                 String          @db.Text
  phone                   String          @db.VarChar(50)

  unitId                  String          @map("unit_id") @db.VarChar(255)
  unit                    Unit            @relation("UnitMembers", fields: [unitId], references: [id], onDelete: Restrict)

  status                  MemberStatus
  closureReason           ClosureReason?  @map("closure_reason")
  closureNotes            String?         @map("closure_notes") @db.Text

  subscriptionStartDate   DateTime        @map("subscription_start_date") @db.Date
  nominees                Json
  firstWitness            Json            @map("first_witness")
  secondWitness           Json            @map("second_witness")

  parentDepartment        String?         @map("parent_department") @db.VarChar(255)

  dateApplied             DateTime        @map("date_applied") @db.Date
  receiptDate             DateTime        @map("receipt_date") @db.Date
  allotmentDate           DateTime        @map("allotment_date") @db.Date

  createdAt               DateTime        @default(now()) @map("created_at")
  updatedAt               DateTime        @updatedAt @map("updated_at")

  payments                Payment[]
  transfers               Transfer[]

  @@index([unitId])
  @@map("members")
}

model Payment {
  id          String   @id @db.VarChar(255)
  memberId    String   @map("member_id") @db.VarChar(255)
  amount      Decimal  @db.Decimal(10, 2)
  months      Json
  paymentDate DateTime @map("payment_date")

  member      Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId])
  @@map("payments")
}

model Transfer {
  id            String   @id @db.VarChar(255)
  memberId      String   @map("member_id") @db.VarChar(255)
  fromUnitId    String   @map("from_unit_id") @db.VarChar(255)
  toUnitId      String   @map("to_unit_id") @db.VarChar(255)
  transferDate  DateTime @map("transfer_date")
  createdAt     DateTime @default(now()) @map("created_at")

  member        Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)
  fromUnit      Unit     @relation("FromUnit", fields: [fromUnitId], references: [id])
  toUnit        Unit     @relation("ToUnit", fields: [toUnitId], references: [id])

  @@index([memberId])
  @@index([fromUnitId])
  @@index([toUnitId])
  @@map("transfers")
}

model Setting {
  id    String @id @default(uuid())
  key   String @unique
  value String @db.Text

  @@map("settings")
}
